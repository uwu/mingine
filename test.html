<!DOCTYPE html>

<body>
<div id="miniphys-root"></div>
</body>

<script type="module">
	import * as mp from "./dist/JsApi.js"

	window.mp = mp;
	
	function createTearDrop(o) {
		o.collider = !o.collide 
            ? mp.createColliderNull()
            : mp.createColliderComposite(
                mp.createColliderCircle(o.radius, mp.vo()),
                //mp.createColliderNull()
                // TODO: why is rect-circle collision broken?
                 mp.createColliderRect(mp.vo(), mp.v(o.radius, o.radius))
            );
        
		o.blOffset = mp.v(o.radius, o.radius);
		return mp.createObject(o);
    }

	const renderScale = 100;

	const engine = mp.createEngine(mp.createScene({
		scale: renderScale,
		rootStyles: {border: "1px solid gray"},
		canvasSize: mp.v(2, 2),
		postTickHooks: [
			// basic floor collision
			([s, t]) => {
				for (const o of s.objects) {
					const p = o.physicsObj;

					const newPos = p.pos.add(p.velocity.scale(t));

					if (newPos.y < 0.1 && p.velocity.y < 0)
						p.velocity = mp.v(p.velocity.x, p.velocity.y * -0.8);
				}
			},

			// box collision test
			([s, _t]) => {
				// Array.from(s.objects);
				const objects = s.getObjects();
				const bouncingBall = objects.find(o => o.id === "BOUNCING_BALL");
				const rotatingRect = objects.find(o => o.id === "ROTATING_RECT");

				rotatingRect.styles.borderColor =
					mp.areColliding(bouncingBall, rotatingRect)
						? "red" : "";
			}
		],

		objects: [
			mp.createRect({
				id: "ROTATING_RECT",
				width: 0.4,
				height: 0.3,
				styles: {
					// TODO: renderer system to handle (some!) styles
					width: `${0.4 * renderScale}px`,
					height: `${0.3 * renderScale}px`,
					border: "1px solid black"
				},
				collide: true,
				mass:  1, //Infinity,
				// 1/12 m (h^2+w^2)
				momentOfInertia: Infinity, // cba to type out full calc
				//angVelocity: 1,
                angle: 0.85,
				pos: mp.v(1, 0.75)
			}),

			createTearDrop({
				id: "BOUNCING_BALL",
				radius: 0.1,
				styles: {
					width: `${0.2 * renderScale}px`,
					height: `${0.2 * renderScale}px`,
					border: "1px solid black",
					borderTop: "1px solid red",
					borderRight: "1px solid red",
					borderRadius: "999px 0 999px 999px"
				},
				collide: true,
				mass: 0.5,
				// mass^2 * area
				momentOfInertia: (0.5 * 0.5) * (0.1 * 0.1),
				pos: mp.v(0, 1.8),

				forces: [
					mp.forceModels.weight(mp.consts.earthGravity),
					mp.forceModels.spring(5, mp.v(1, 1.5), mp.v(0.1, 0.1)),
					mp.forceModels.stillAirDrag(mp.consts.earthAirDensity, Math.PI * 0.1 * 0.1, 0.47),

					mp.forceModels.simpleDamping(0.25, 0.05)
				]
			}),
		]
	}));

	const root = document.getElementById("miniphys-root");
	engine.mount(root);
	engine.start();
</script>